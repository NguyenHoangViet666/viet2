<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tool D·ªçn D·∫πp Database</title>
    <style>
        body { font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; background: #262626; color: white; }
        .container { background: #333; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 2px solid #ef4444; }
        h1 { color: #ef4444; margin-bottom: 20px; }
        button { padding: 15px 30px; font-size: 1.1rem; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { background: #dc2626; }
        button:disabled { background: #666; cursor: not-allowed; }
        #logs { margin-top: 20px; background: #1a1a1a; padding: 20px; border-radius: 8px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; }
        .error { color: #fca5a5; }
        .success { color: #4ade80; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üí£ TH√ôNG R√ÅC H·∫†T NH√ÇN (Clear DB)</h1>
        <p>C√¥ng c·ª• n√†y s·∫Ω x√≥a S·∫†CH S·∫º to√†n b·ªô d·ªØ li·ªáu (Truy·ªán, User, Comment, Ch∆∞∆°ng, B√†i ƒëƒÉng) kh·ªèi Firestore. KH√îNG TH·ªÇ KH√îI PH·ª§C!</p>
        
        <button id="btn-clear">K√çCH HO·∫†T X√ìA S·∫†CH S·∫º!</button>

        <div id="logs">Ch·ªù l·ªánh...</div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, writeBatch, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const COLLECTIONS_TO_WIPE = ['novels', 'users', 'comments', 'chapters', 'notifications', 'posts'];
        const btn = document.getElementById('btn-clear');
        const logs = document.getElementById('logs');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'success') div.className = 'success';
            if (type === 'error') div.className = 'error';
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        btn.addEventListener('click', async () => {
            if (!confirm("B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA TO√ÄN B·ªò DATABASE KH√îNG?")) return;

            btn.disabled = true;
            logs.innerHTML = '';
            log("üõë ƒê√£ x√°c nh·∫≠n. B·∫Øt ƒë·∫ßu d·ªçn d·∫πp...");

            for (const colName of COLLECTIONS_TO_WIPE) {
                try {
                    log(`ƒêang d·ªçn collection: ${colName}...`);
                    
                    // L·∫•y t·∫•t c·∫£ documents trong collection
                    const snapshot = await getDocs(collection(db, colName));
                    
                    if (snapshot.empty) {
                        log(`[${colName}] Kh√¥ng c√≥ g√¨ ƒë·ªÉ x√≥a.`);
                        continue;
                    }
                    
                    // D√πng Batch ƒë·ªÉ x√≥a h√†ng lo·∫°t (t·ªëi ƒëa 500 document m·ªói batch)
                    const batch = writeBatch(db);
                    let deleteCount = 0;
                    
                    snapshot.docs.forEach(d => {
                        batch.delete(d.ref);
                        deleteCount++;
                    });
                    
                    await batch.commit();
                    log(`[${colName}] X√≥a th√†nh c√¥ng ${deleteCount} documents.`, 'success');

                } catch (e) {
                    log(`‚ùå L·ªói X√ìA collection ${colName}: ${e.message}`, 'error');
                    break; 
                }
            }

            log(`--- HO√ÄN T·∫§T D·ªåN D·∫∏P! ---`);
            log(`üëâ F5 l·∫°i web v√† b∆°m d·ªØ li·ªáu m·ªõi.`, 'success');
            btn.disabled = false;
        });
    </script>
</body>
</html>